<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>

    html{
      overflow-y: scroll;
    }
    body {
      margin: 10px;
    }
    section{
      margin: auto;
      position: relative;
    }
    img{
      display: block;
      transition: 0.3;
      position: absolute;


    }
  </style>
</head>
<body>
  <section>

  </section>
  <script src="https://unpkg.com/lodash"></script>
  <script>
    var cats = [
      {
        "url": "photo-103450229.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/photo-103450229.jpg",
        "width": 675,
        "height": 900
      },
      {
        "url": "photo-108273877.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/photo-108273877.jpg",
        "width": 1170,
        "height": 780
      },
      {
        "url": "photo-115203323.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/photo-115203323.jpg",
        "width": 1170,
        "height": 780
      },
      {
        "url": "photo-23583825.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/photo-23583825.jpg",
        "width": 2048,
        "height": 1536
      },
      {
        "url": "stock-photo-123942383.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-123942383.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-124559545.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-124559545.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-132046989.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-132046989.jpg",
        "width": 1170,
        "height": 780
      },
      {
        "url": "stock-photo-132118343.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-132118343.jpg",
        "width": 2000,
        "height": 1339
      },
      {
        "url": "stock-photo-132311221.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-132311221.jpg",
        "width": 1920,
        "height": 1080
      },
      {
        "url": "stock-photo-132586903.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-132586903.jpg",
        "width": 2000,
        "height": 1334
      },
      {
        "url": "stock-photo-135203031.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-135203031.jpg",
        "width": 1000,
        "height": 668
      },
      {
        "url": "stock-photo-135626379.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-135626379.jpg",
        "width": 2000,
        "height": 1500
      },
      {
        "url": "stock-photo-136947953.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-136947953.jpg",
        "width": 2000,
        "height": 1348
      },
      {
        "url": "stock-photo-138378295.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-138378295.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-138436811.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-138436811.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-142950305.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-142950305.jpg",
        "width": 2000,
        "height": 1125
      },
      {
        "url": "stock-photo-143046061.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-143046061.jpg",
        "width": 843,
        "height": 1000
      },
      {
        "url": "stock-photo-143181649.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-143181649.jpg",
        "width": 2000,
        "height": 1298
      },
      {
        "url": "stock-photo-144530143.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-144530143.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-144730939.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-144730939.jpg",
        "width": 1000,
        "height": 1000
      },
      {
        "url": "stock-photo-145414771.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-145414771.jpg",
        "width": 780,
        "height": 1170
      },
      {
        "url": "stock-photo-146038669.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-146038669.jpg",
        "width": 2000,
        "height": 1335
      },
      {
        "url": "stock-photo-146231033.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-146231033.jpg",
        "width": 2000,
        "height": 1335
      },
      {
        "url": "stock-photo-146914861.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-146914861.jpg",
        "width": 843,
        "height": 1000
      },
      {
        "url": "stock-photo-147877407.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-147877407.jpg",
        "width": 2000,
        "height": 1334
      },
      {
        "url": "stock-photo-147969173.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-147969173.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-148015373.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-148015373.jpg",
        "width": 1170,
        "height": 781
      },
      {
        "url": "stock-photo-148704233.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-148704233.jpg",
        "width": 1170,
        "height": 884
      },
      {
        "url": "stock-photo-148928293.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-148928293.jpg",
        "width": 1170,
        "height": 781
      },
      {
        "url": "stock-photo-148950715.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-148950715.jpg",
        "width": 1170,
        "height": 775
      },
      {
        "url": "stock-photo-21951271.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-21951271.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-21964829.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-21964829.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-22618399.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-22618399.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-31201539.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-31201539.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-34598868.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-34598868.jpg",
        "width": 542,
        "height": 768
      },
      {
        "url": "stock-photo-47252094.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-47252094.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-51980510.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-51980510.jpg",
        "width": 666,
        "height": 1000
      },
      {
        "url": "stock-photo-55601508.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-55601508.jpg",
        "width": 666,
        "height": 1000
      },
      {
        "url": "stock-photo-65681789.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-65681789.jpg",
        "width": 1840,
        "height": 1232
      },
      {
        "url": "stock-photo-70461471.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-70461471.jpg",
        "width": 1000,
        "height": 1000
      },
      {
        "url": "stock-photo-71801901.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-71801901.jpg",
        "width": 2000,
        "height": 1335
      },
      {
        "url": "stock-photo-71913567.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-71913567.jpg",
        "width": 2000,
        "height": 1328
      },
      {
        "url": "stock-photo-72223295.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-72223295.jpg",
        "width": 2000,
        "height": 1335
      },
      {
        "url": "stock-photo-72620185.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-72620185.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-74402039.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-74402039.jpg",
        "width": 666,
        "height": 1000
      },
      {
        "url": "stock-photo-75097491.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-75097491.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-75186237.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-75186237.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-79250373.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-79250373.jpg",
        "width": 2000,
        "height": 1325
      },
      {
        "url": "stock-photo-79692589.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-79692589.jpg",
        "width": 670,
        "height": 1000
      },
      {
        "url": "stock-photo-7979718.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-7979718.jpg",
        "width": 1024,
        "height": 680
      },
      {
        "url": "stock-photo-7980252.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-7980252.jpg",
        "width": 1024,
        "height": 680
      },
      {
        "url": "stock-photo-81390687.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-81390687.jpg",
        "width": 2000,
        "height": 1591
      },
      {
        "url": "stock-photo-81988949.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-81988949.jpg",
        "width": 667,
        "height": 1000
      },
      {
        "url": "stock-photo-83149705.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-83149705.jpg",
        "width": 775,
        "height": 1170
      }
    ]
    cats = [..._.cloneDeep(cats),..._.cloneDeep(cats),..._.cloneDeep(cats)]
    cats = [..._.cloneDeep(cats),..._.cloneDeep(cats),..._.cloneDeep(cats)]
    cats = [..._.cloneDeep(cats),..._.cloneDeep(cats),..._.cloneDeep(cats)]
    cats = [..._.cloneDeep(cats),..._.cloneDeep(cats),..._.cloneDeep(cats)]
    var section = document.querySelector('section')
    var prevWidth = 0
    var prevCloums = 0
    var 余量 = 200
    function run(){

      if(window.innerWidth == prevWidth){
        return
      }else{
        prevWidth = window.innerWidth
      }

      var colWidth = 180
      var gap = 10
      var  columns = Math.floor((window.innerWidth - 30 )/ colWidth)

      if(columns == prevCloums){
        return
      }else{
        prevCloums = columns
      }
      section.innerHTML = ""
      var containerWidth = columns * colWidth + (columns -1) * gap
      section.style.width = containerWidth + "px"


      var colHeights = Array(columns).fill(0)

      for(var cat of cats){
        var minColHeight = Math.min(...colHeights)
        var minColIdx = colHeights.indexOf(minColHeight)
        cat.left = minColIdx * (colWidth + gap)
        cat.top = minColHeight
        cat.displayWidth = colWidth
        cat.displayHeight = colWidth * cat.height / cat.width
        colHeights[minColIdx] += cat.displayHeight + gap
      }
      section.style.height = Math.max(...colHeights) + "px"
      cats.filter(cat =>{
        return cat.top +cat.displayHeight +10 > window.pageYOffset -余量   &&
               cat.top <= window.pageYOffset + window.innerHeight + 余量

      }).forEach(cat =>{
        cat.show = true
        var img = document.createElement('img')
        img.src = cat.fullUrl
        img.style.width = cat.displayWidth + "px"
        img.style.height = cat.displayHeight + "px"
        img.style.transform = `translate(${cat.left}px, ${cat.top}px)`
        section.append(img)
      })

    }
    run()
    window.onresize = run
    var prevPageYOffset = 0
    window.onscroll = (e) =>{

      var imgs = document.querySelectorAll("img")
      imgs.forEach(img =>{
        var box = img.getBoundingClientRect()
        if(window.pageYOffset > prevPageYOffset){
          if(box.bottom < -余量){
            section.removeChild(img)
          }
        }
        if(window.pageYOffset < prevPageYOffset){
          if(box.top >  window.innerHeight + 余量){
            section.removeChild(img)
          }

        }
      })
      var shownCats = cats.filter(cat => cat.show == true)
      var toBeShow =  cats.filter(cat =>{
        return cat.top +cat.displayHeight > window.pageYOffset -余量  &&
        cat.top < window.pageYOffset + window.innerHeight + 余量
      })
      var leaveCats = _.difference(shownCats,toBeShow)
      leaveCats.forEach(it => {
        it.show = false
      })
      var newCats = _.difference(toBeShow,shownCats)
      newCats.forEach(cat =>{

        var img = document.createElement('img')
        img.src = cat.fullUrl
        img.style.width = cat.displayWidth + "px"
        img.style.height = cat.displayHeight + "px"
        img.style.transform = `translate(${cat.left}px, ${cat.top}px)`
        section.append(img)
      })

      prevPageYOffset = window.pageYOffset
    }


    var  section = document.querySelector("section")
    var z = 1
    section.addEventListener("click" , function(e){
      if(e.target.matches("img")){
        var img = e.target
        if(img.style.transform == ''){
          var box = img.getBoundingClientRect()
          var cx = box.left + box.width / 2
          var cy = box.top + box.height / 2
          var vx = window.innerWidth / 2
          var vy = window.innerHeight / 2
          var movex = vx - cx
          var movey = vy - cy
          var zoomx = window.innerWidth / box.width
          var zommy = window.innerHeight / box.height
          img.style.zIndex = z++
          img.style.transform = `translate(${movex}px, ${movey}px) scale(${Math.min(zoomx,zommy)})`
          img.style.boxShadow = '0 0 0 9999px black'
        }else{
          img.style.transform = ''
          img.style.boxShadow = ''
        }
      }
    })
  </script>
</body>
</html>
